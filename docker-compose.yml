services:

  service-registry:
    build:
      context: ./service-registry
      dockerfile: Dockerfile
    container_name: service-registry
    environment:
      - EUREKA_INSTANCE_HOSTNAME=service-registry
      - EUREKA_CLIENT_FETCH_REGISTRY=false
      - EUREKA_CLIENT_REGISTER_WITH_EUREKA=false
    networks:
      - app-network
    ports:
      - "8761:8761"

  mysql_db1:
    image: mysql:lts
    container_name: mysql_db1
    environment:
      MYSQL_ROOT_PASSWORD: orders-password
      MYSQL_DATABASE: orders_db
    volumes:
      - orders_db_data:/var/lib/mysql
    networks:
      - app-network
    ports:
      - "33061:3306"
    healthcheck:
      test: [ "CMD", "mysqladmin", "ping", "-h", "localhost" ]
      interval: 10s
      timeout: 5s
      retries: 5

  orders-microservice:
    build:
      context: ./orders
      dockerfile: Dockerfile
    container_name: orders-microservice
    environment:
      - SPRING_DATASOURCE_URL=jdbc:mysql://mysql_db1:3306/orders_db
      - SPRING_DATASOURCE_USERNAME=root
      - SPRING_DATASOURCE_PASSWORD=orders-password
      - EUREKA_CLIENT_SERVICEURL_DEFAULTZONE=http://service-registry:8761/eureka/
    depends_on:
      mysql_db1:
        condition: service_healthy
      service-registry:
        condition: service_started
    networks:
      - app-network
    ports:
      - "8081:8081"

  mysql_db2:
    image: mysql:lts
    container_name: mysql_db2
    environment:
      MYSQL_ROOT_PASSWORD: users-password
      MYSQL_DATABASE: users_db
    volumes:
      - users_db_data:/var/lib/mysql
    networks:
      - app-network
    ports:
      - "33062:3306"
    healthcheck:
      test: [ "CMD", "mysqladmin", "ping", "-h", "localhost" ]
      interval: 10s
      timeout: 5s
      retries: 5

  users-microservice:
    build:
      context: ./users
      dockerfile: Dockerfile
    container_name: users-microservice
    environment:
      - SPRING_DATASOURCE_URL=jdbc:mysql://mysql_db2:3306/users_db
      - SPRING_DATASOURCE_USERNAME=root
      - SPRING_DATASOURCE_PASSWORD=users-password
      - EUREKA_CLIENT_SERVICEURL_DEFAULTZONE=http://service-registry:8761/eureka/
    depends_on:
      mysql_db2:
        condition: service_healthy
      service-registry:
        condition: service_started
    networks:
      - app-network
    ports:
      - "8083:8083"

  products_db:
    image: mongo:latest
    container_name: products_db
    environment:
      MONGO_INITDB_DATABASE: products_db
    volumes:
      - products_db_data:/data/db
    networks:
      - app-network
    ports:
      - "27017:27017"

  products-microservice:
    build:
      context: ./products
      dockerfile: Dockerfile
    container_name: products-microservice
    environment:
      - SPRING_DATA_MONGODB_URI=mongodb://products_db:27017/products_db
      - EUREKA_CLIENT_SERVICEURL_DEFAULTZONE=http://service-registry:8761/eureka/
    depends_on:
      products_db:
          condition: service_started
      service-registry:
          condition: service_started
    networks:
      - app-network
    ports:
      - "8082:8082"

networks:
  app-network:
    driver: bridge

volumes:
  orders_db_data:
  users_db_data:
  products_db_data:
